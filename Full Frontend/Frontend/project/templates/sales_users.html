<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Utilisateurs - D-WEE</title>
  <link rel="stylesheet" href="../static/salesCSS.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" />
</head>
<body>
  <aside class="sidebar">
    <div class="logo">
      <img src="https://dweehealthcare.com/wp-content/uploads/2023/08/D-wee-Final.png" alt="DWEE Logo" />
      <div>
        <div class="logo-text">D-WEE Healthcare</div>
        <div class="logo-subtitle">Tableau de Bord Commercial</div>
      </div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item"><a class="nav-link" href="sales_dashboard.html"><i class="fas fa-tachometer-alt"></i> Tableau de Bord</a></div>
      <div class="nav-item"><a class="nav-link active" href="sales_users.html"><i class="fas fa-users"></i> Utilisateurs</a></div>
      <div class="nav-item"><a class="nav-link" href="sales_dkits.html"><i class="fas fa-box"></i> D-KIT Devices</a></div>
      <div class="nav-item"><a class="nav-link" href="sales_assignments.html"><i class="fas fa-handshake"></i> Assignations</a></div>
      <div class="nav-item"><a class="nav-link" href="sales_reports.html"><i class="fas fa-chart-bar"></i> Rapports</a></div>
      <div class="nav-item"><a class="nav-link" href="sales_profile.html"><i class="fas fa-user"></i> Profil</a></div>
    </nav>
    <div class="sidebar-user">
      <div class="user-avatar">JD</div>
      <div class="user-details">
        <div class="user-name">Jean Dupont</div>
        <div class="user-role">Représentant Commercial</div>
      </div>
      <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </aside>

  <main class="main-content">
    <!-- Users Tab Content -->
    <div id="users" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="card-icon fas fa-users"></i>
            Mes Clients
          </div>
          <button class="btn btn-primary btn-small" onclick="openModal('addUserModal')">
            <i class="fas fa-plus"></i> Ajouter Client
          </button>
        </div>
        <div class="table-container">
          <table class="table">            <thead>
              <tr>
                <th>Nom Complet</th>
                <th>Email</th>
                <th>Téléphone</th>
                <th>Pays</th>
                <th>Date d'Inscription</th>
                <th>Actions</th>
              </tr>
            </thead><tbody id="usersTableBody">
              <!-- Users will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Placeholder for Modals -->
  <div id="modalContainer"></div>

  <script>    // Store users data
    let users = [
      {
        id: 1,
        firstName: "Dr. Amina",
        lastName: "Ben Ali",
        email: "amina.benali@email.com",
        phonePrefix: "+216",
        phone: "71 123 456",
        country: "Tunisia",
        province: "Tunis",
        address: "12 Rue de la Santé, Tunis",
        profession: "Cardiologue",
        password: "TempPass123!",
        createdAt: new Date('2024-01-15'),
        emailSent: true
      },
      {
        id: 2,
        firstName: "M. Sami",
        lastName: "Kacem",
        email: "sami.kacem@email.com",
        phonePrefix: "+216",
        phone: "71 654 321",
        country: "Tunisia",
        province: "Sfax",
        address: "5 Avenue de France, Sfax",
        profession: "Pharmacien",
        password: "SecurePass456!",
        createdAt: new Date('2024-02-10'),
        emailSent: true
      }
    ];    // API key and base URL
    const apiKey = 'QXJXRGZqd085dGRHYlVocmR2cFdrUlVpUnFOVkVMNm1adENlWmxEbw==';

    const apiBase = 'https://api.countrystatecity.in/v1';

    // Fetch all countries
    async function fetchCountryData() {
      const response = await fetch(`${apiBase}/countries`, {
        headers: {
          'X-CSCAPI-KEY': apiKey
        }
      });
      if (!response.ok) {
        console.error('Failed to fetch country data');
        return [];
      }
      return await response.json();
    }

    // Fetch states/provinces for a country
    async function fetchProvinces(countryIso) {
      const response = await fetch(`${apiBase}/countries/${countryIso}/states`, {
        headers: {
          'X-CSCAPI-KEY': apiKey
        }
      });
      if (!response.ok) {
        console.error('Failed to fetch province data');
        return [];
      }
      return await response.json();
    }

    // Populate country dropdown on page load
    document.addEventListener('DOMContentLoaded', async function() {
      refreshUsersTable();

      const countrySelect = document.getElementById('addUserCountry');
      if (countrySelect) {
        const countries = await fetchCountryData();
        countries.forEach(country => {
          countrySelect.innerHTML += `<option value="${country.iso2}" data-phone="${country.phonecode}">${country.name}</option>`;
        });

        // Add change event to update provinces and country code
        countrySelect.addEventListener('change', updateProvinces);
      }
    });

    // Update provinces and country code when country changes
    async function updateProvinces() {
      const countrySelect = document.getElementById('addUserCountry');
      const countryIso = countrySelect.value;
      const countryCode = countrySelect.options[countrySelect.selectedIndex].getAttribute('data-phone');
      const provinceSelect = document.getElementById('addUserProvince');
      const countryCodeInput = document.getElementById('addUserCountryCode');

      // Set country code
      if (countryCodeInput) {
        console.log('Setting country code:', countryCode); // Add this line
        countryCodeInput.value = `+${countryCode}`;
      }

      // Fetch and populate provinces
      provinceSelect.innerHTML = '<option value="">Sélectionner...</option>';
      if (countryIso) {
        const provinces = await fetchProvinces(countryIso);
        provinces.forEach(province => {
          provinceSelect.innerHTML += `<option value="${province.name}">${province.name}</option>`;
        });
      }
    }

    // Password generation
    function generateRandomPassword() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
      let password = '';
      for (let i = 0; i < 12; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      const passwordField = document.getElementById('addUserPassword');
      if (passwordField) {
        passwordField.value = password;
      }
    }

    // Modal management
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'flex';
        // Auto-generate password when opening add user modal
        if (modalId === 'addUserModal') {
          setTimeout(() => {
            generateRandomPassword();
          }, 100);
        }
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Email functions
    function sendUserInfoByEmail() {
      const userData = {
        firstName: document.getElementById('addUserFirstName').value,
        lastName: document.getElementById('addUserLastName').value,
        email: document.getElementById('addUserEmail').value,
        country: document.getElementById('addUserCountry').value,
        province: document.getElementById('addUserProvince').value,
        address: document.getElementById('addUserAddress').value,
        phone: document.getElementById('addUserCountryCode').value + document.getElementById('addUserPhone').value,
        password: document.getElementById('addUserPassword').value
      };
      
      const emailBody = `Nouveau client créé:\n\nPrénom: ${userData.firstName}\nNom: ${userData.lastName}\nEmail: ${userData.email}\nPays: ${userData.country}\nProvince: ${userData.province}\nAdresse: ${userData.address}\nTéléphone: ${userData.phone}\nMot de passe: ${userData.password}`;
      
      window.open(`mailto:${userData.email}?subject=Informations de votre compte&body=${encodeURIComponent(emailBody)}`);
    }

    function sendViewedUserInfoByEmail() {
      const userData = {
        firstName: document.getElementById('viewUserFirstName').textContent,
        lastName: document.getElementById('viewUserLastName').textContent,
        email: document.getElementById('viewUserEmail').textContent,
        country: document.getElementById('viewUserCountry').textContent,
        province: document.getElementById('viewUserProvince').textContent,
        address: document.getElementById('viewUserAddress').textContent,
        phone: document.getElementById('viewUserPhone').textContent,
        password: document.getElementById('viewUserPassword').textContent
      };
      
      const emailBody = `Informations client:\n\nPrénom: ${userData.firstName}\nNom: ${userData.lastName}\nEmail: ${userData.email}\nPays: ${userData.country}\nProvince: ${userData.province}\nAdresse: ${userData.address}\nTéléphone: ${userData.phone}\nMot de passe: ${userData.password}`;
      
      window.open(`mailto:${userData.email}?subject=Vos informations de compte&body=${encodeURIComponent(emailBody)}`);
    }

    // Function to add new user
    function addUser(event) {
      event.preventDefault();
      
      const firstName = document.getElementById('addUserFirstName').value;
      const lastName = document.getElementById('addUserLastName').value;
      const email = document.getElementById('addUserEmail').value;
      const country = document.getElementById('addUserCountry').value;
      const province = document.getElementById('addUserProvince').value;
      const address = document.getElementById('addUserAddress').value;
      const countryCode = document.getElementById('addUserCountryCode').value;
      const phone = document.getElementById('addUserPhone').value;
      const password = document.getElementById('addUserPassword').value;
      
      // Add to users array
      users.push({
        id: users.length + 1,
        firstName,
        lastName,
        email,
        phonePrefix: countryCode,
        phone,
        country,
        province,
        address,
        password,
        createdAt: new Date(),
        emailSent: false
      });
      
      // Refresh table
      refreshUsersTable();
      
      // Close modal and reset form
      closeModal('addUserModal');
      document.querySelector('#addUserModal form').reset();
      
      alert('Client ajouté avec succès!');
    }

    // Function to open view modal with user data
    function openEditUserModal(userIndex) {
      const user = users[userIndex];
      
      ensureModalsLoaded().then(() => {
        // Populate view modal (read-only)
        document.getElementById('viewUserFirstName').textContent = user.firstName;
        document.getElementById('viewUserLastName').textContent = user.lastName;  
        document.getElementById('viewUserEmail').textContent = user.email;
        document.getElementById('viewUserCountry').textContent = user.country;
        document.getElementById('viewUserProvince').textContent = user.province;
        document.getElementById('viewUserAddress').textContent = user.address;
        document.getElementById('viewUserPhone').textContent = user.phonePrefix + ' ' + user.phone;
        document.getElementById('viewUserPassword').textContent = user.password;
        
        openModal('editUserModal');
      });
    }

    // Function to ensure modals are loaded
    function ensureModalsLoaded() {
      return new Promise((resolve) => {
        if (document.getElementById('addUserModal')) {
          resolve();
        } else {
          // Wait a bit more for modals to load
          setTimeout(resolve, 100);
        }
      });
    }

    // Function to refresh the users table
    function refreshUsersTable() {
      const tableBody = document.getElementById('usersTableBody');
      tableBody.innerHTML = '';
      
      users.forEach((user, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${user.firstName} ${user.lastName}</td>
          <td>${user.email}</td>
          <td>${user.phonePrefix} ${user.phone}</td>
          <td>${user.country}</td>
          <td>${user.createdAt.toLocaleDateString('fr-FR')}</td>
          <td class="table-actions">
            <button class="btn btn-secondary btn-small" onclick="openEditUserModal(${index})" title="Voir les détails">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-danger btn-small" onclick="deleteUser(${index})" title="Supprimer">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    // Function to delete user
    function deleteUser(index) {
      if (confirm('Êtes-vous sûr de vouloir supprimer ce client ?')) {
        users.splice(index, 1);
        refreshUsersTable();
      }
    }

    // Initialize the table when page loads
    document.addEventListener('DOMContentLoaded', function() {
      refreshUsersTable();
    });

    // Fetch and inject the modal HTML from sales_modals.html
    fetch('sales_modals.html')
      .then(response => response.text())
      .then(async html => {
        document.getElementById('modalContainer').innerHTML = html;
        // Initialize password generation after modals are loaded
        setTimeout(() => {
          if (document.getElementById('addUserPassword')) {
            generateRandomPassword();
          }
        }, 200);

        // Populate country and phone code dropdowns after modal is loaded
        const countrySelect = document.getElementById('addUserCountry');
        const phoneCodeSelect = document.getElementById('addUserCountryCode');
        if (countrySelect && phoneCodeSelect) {
          const countries = await fetchCountryData();
          countrySelect.innerHTML = '<option value="">Sélectionner...</option>';
          phoneCodeSelect.innerHTML = '<option value="">Sélectionner...</option>';
          countries.forEach(country => {
            countrySelect.innerHTML += `<option value="${country.iso2}" data-phone="${country.phonecode}">${country.name}</option>`;
            // Only add unique phone codes
            if (![...phoneCodeSelect.options].some(opt => opt.value === `+${country.phonecode}`)) {
              phoneCodeSelect.innerHTML += `<option value="+${country.phonecode}">+${country.phonecode}</option>`;
            }
          });
          countrySelect.addEventListener('change', function() {
            updateProvinces();
            // Auto-select phone code when country changes
            const selectedOption = countrySelect.options[countrySelect.selectedIndex];
            const phoneCode = selectedOption.getAttribute('data-phone');
            if (phoneCode) {
              phoneCodeSelect.value = `+${phoneCode}`;
            } else {
              phoneCodeSelect.value = '';
            }
          });

          // Set default country and phone code
          if (countrySelect.options.length > 1) {
            countrySelect.selectedIndex = 1;
            const selectedOption = countrySelect.options[1];
            const phoneCode = selectedOption.getAttribute('data-phone');
            if (phoneCode) {
              phoneCodeSelect.value = `+${phoneCode}`;
            }
            updateProvinces();
          }
        }
      })
      .catch(error => {
        console.error('Erreur lors du chargement des modals:', error);
      });
  </script>
  
  <script src="../static/js/sales_common.js"></script>
</body>
</html>